<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
        
        <script type="text/javascript">
            async function afterMapLoad() {}
        </script>

        <script src="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.js"></script>
        <script src="https://unpkg.com/protomaps@1.22.0/dist/protomaps.min.js"></script>

        <script src="https://cdn.jsdelivr.net/npm/leaflet.gridlayer.googlemutant@0.10.0/Leaflet.GoogleMutant.min.js"></script>
        <!-- <script src="../dist/protomaps.js"></script> -->
        <style>
            body, #map {
                height:100vh;
                margin:0px;
            }
        </style>
    </head>
    <body onload="loadmap()">
        <div id="map"></div> 
        <script>
            const loadmap = async () => {
                const map = new L.map('map')
                map.setView(new L.LatLng(-32.119,-59.288), 8)

                map.createPane('pane_GoogleSatelliteHybrid_0');
                map.getPane('pane_GoogleSatelliteHybrid_0').style.zIndex = 0;
                var layer_GoogleSatelliteHybrid_0 = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                    pane: 'pane_GoogleSatelliteHybrid_0',
                    opacity: 1.0,
                    attribution: '',
                    minZoom: 1,
                    maxZoom: 28,
                    minNativeZoom: 0,
                    maxNativeZoom: 19
                });
                layer_GoogleSatelliteHybrid_0;
                map.addLayer(layer_GoogleSatelliteHybrid_0);
                
                var depts = []
                class SuelosSimbolizer {
                    draw(context,geom,z,feature) {
                        // console.log(feature.props)
                        if (!depts.find(d => d["name"] == feature.props.serie_1)) {
                            depts.push({
                                name: feature.props.serie_1,
                                color: "#" + Math.floor(Math.random()*16777215).toString(16)
                            })
                        }
                        
                        context.fillStyle = depts.find(d => d["name"] == feature.props.serie_1)["color"];
                        context.beginPath()
                        for (var poly of geom) {
                            for (var p = 0; p < poly.length-1; p++) {
                                let pt = poly[p]
                                if (p == 0) context.moveTo(pt.x,pt.y)
                                else context.lineTo(pt.x,pt.y)
                            }
                        }
                        context.fill() 
                    }
                }

                var deptsLabels = []
                class DepartSymbolizer {
                    place(layout,geom,feature) {
                        let pt = geom[0][0]
                        let name = feature.props.simb

                        // let to_add = {
                        //     name: name,
                        //     zoom: layout.zoom
                        // }

                        // let label = deptsLabels.find(d => d["name"] == name);
                        // if (label && label.zoom !== layout.zoom)
                        //     deptsLabels = [to_add];

                        // label = deptsLabels.find(d => d["name"] == name);
                        // if (!label)
                        //     deptsLabels.push(to_add)
                        // else
                        //     return;
                            
                        var font = "12px sans-serif"

                        layout.scratch.font = font
                        let metrics = layout.scratch.measureText(name)
                        let width = metrics.width
                        let ascent = metrics.actualBoundingBoxAscent
                        let descent = metrics.actualBoundingBoxDescent
                        let bbox = {minX:pt.x-width/2,minY:pt.y-ascent,maxX:pt.x+width/2,maxY:pt.y+descent}

                        let draw = ctx => {
                            ctx.font = font
                            ctx.fillStyle = "darkslategray"
                            ctx.fillText(name,-width/2,0)
                        }
                        
                        return [{anchor:pt,bboxes:[bbox],draw:draw}]
                    }
                }

                protomaps.leafletLayer({
                    url:'suelos_ER.pmtiles',
                    paint_rules: [
                        {
                            dataLayer: "suelos_ER",
                            symbolizer: new SuelosSimbolizer()
                        } 
                    ],
                    label_rules: [
                        {
                            dataLayer: "suelos_ER",
                            symbolizer: new DepartSymbolizer()
                        } 
                    ]
                }).addTo(map) 
            }
        </script>
    </body>
</html>